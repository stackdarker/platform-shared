openapi: 3.0.3
info:
  title: platform-auth-service API
  version: 1.0.0
  description: Authentication and authorization service for the platform (JWT, sessions, RBAC).
servers:
  - url: http://localhost:8081
    description: Local dev
tags:
  - name: Auth
  - name: Users
  - name: Roles
  - name: Permissions
  - name: Sessions
security:
  - bearerAuth: []

paths:
  /v1/auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      security: [] 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Registered
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "409":
          $ref: "#/components/responses/Error409"
        "422":
          $ref: "#/components/responses/Error422"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/auth/login:
    post:
      tags: [Auth]
      summary: Login and receive JWT access/refresh tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Logged in
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
        "401":
          $ref: "#/components/responses/Error401"
        "422":
          $ref: "#/components/responses/Error422"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh tokens using a refresh token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Refreshed
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
        "401":
          $ref: "#/components/responses/Error401"
        "422":
          $ref: "#/components/responses/Error422"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (revoke current session / refresh token)
      description: Requires access token. Implementation may revoke session and/or refresh token.
      responses:
        "204":
          description: Logged out
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "401":
          $ref: "#/components/responses/Error401"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/auth/me:
    get:
      tags: [Auth]
      summary: Get current authenticated user
      responses:
        "200":
          description: Current user
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Error401"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/users:
    get:
      tags: [Users]
      summary: List users (admin)
      description: Requires permission USERS_READ (example).
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Paged users
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PagedUsers"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/users/{userId}:
    get:
      tags: [Users]
      summary: Get user by id (admin)
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        "200":
          description: User
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/roles:
    get:
      tags: [Roles]
      summary: List roles (admin)
      responses:
        "200":
          description: Roles
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RolesList"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/permissions:
    get:
      tags: [Permissions]
      summary: List permissions (admin)
      responses:
        "200":
          description: Permissions
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PermissionsList"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"

  /v1/sessions:
    get:
      tags: [Sessions]
      summary: List sessions for current user
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Paged sessions
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PagedSessions"
        "401":
          $ref: "#/components/responses/Error401"
        "500":
          $ref: "#/components/responses/Error500"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  headers:
    X-Request-Id:
      description: Correlation id for this request.
      schema:
        type: string

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    Cursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string
        description: Opaque cursor for pagination.

  responses:
    Error400:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error403:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error404:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error409:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error422:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error500:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
        displayName:
          type: string
          maxLength: 80

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    RefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string
          description: Refresh token previously issued by login/refresh.

    AuthTokens:
      type: object
      required: [accessToken, refreshToken, tokenType, expiresIn]
      properties:
        tokenType:
          type: string
          example: Bearer
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          description: Access token lifetime in seconds.
          example: 900

    User:
      type: object
      required: [id, email, createdAt]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        displayName:
          type: string
          nullable: true
        roles:
          type: array
          items:
            $ref: "#/components/schemas/Role"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    Role:
      type: object
      required: [id, name]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: ADMIN
        permissions:
          type: array
          items:
            $ref: "#/components/schemas/Permission"

    Permission:
      type: object
      required: [id, name]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: USERS_READ

    Session:
      type: object
      required: [id, userId, createdAt, lastSeenAt, revoked]
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        lastSeenAt:
          type: string
          format: date-time
        revoked:
          type: boolean

    PageMeta:
      type: object
      required: [limit, hasNext]
      properties:
        limit:
          type: integer
        nextCursor:
          type: string
          nullable: true
        hasNext:
          type: boolean

    PagedUsers:
      type: object
      required: [data, page]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/User"
        page:
          $ref: "#/components/schemas/PageMeta"

    PagedSessions:
      type: object
      required: [data, page]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Session"
        page:
          $ref: "#/components/schemas/PageMeta"

    RolesList:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Role"

    PermissionsList:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Permission"

    ErrorItem:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          example: FIELD_REQUIRED
        message:
          type: string
          example: email is required
        field:
          type: string
          nullable: true
        rejectedValue:
          nullable: true
        meta:
          type: object
          additionalProperties: true
          nullable: true

    ErrorResponse:
      type: object
      required: [requestId, timestamp, status, error, message, path, code]
      properties:
        requestId:
          type: string
          example: 01J2Q7K9RZ7M8A9R6V3G7P1D2E
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
          example: 422
        error:
          type: string
          example: UNPROCESSABLE_ENTITY
        message:
          type: string
          example: Validation failed
        path:
          type: string
          example: /v1/auth/login
        code:
          type: string
          example: AUTH_VALIDATION_FAILED
        details:
          type: array
          items:
            $ref: "#/components/schemas/ErrorItem"
          nullable: true
